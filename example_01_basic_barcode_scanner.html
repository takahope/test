<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>範例 01：基礎條碼掃描 (Quagga2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>

    <style>
        #reader {
            position: relative;
            width: 100%;
            min-height: 300px;
            background: #2c2c2c;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        #reader video, #reader canvas {
            width: 100% !important;
            height: auto !important;
            object-fit: cover;
        }
        #reader canvas.drawingBuffer {
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

    <div class="max-w-2xl mx-auto bg-white shadow-lg rounded-lg p-6">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">基礎條碼掃描器</h1>

        <!-- 控制按鈕 -->
        <div class="mb-4 space-y-2">
            <button id="start-btn" class="w-full bg-blue-600 text-white px-4 py-3 rounded-md hover:bg-blue-700">
                啟動掃描
            </button>
            <button id="stop-btn" class="w-full bg-red-600 text-white px-4 py-3 rounded-md hover:bg-red-700 hidden">
                停止掃描
            </button>
        </div>

        <!-- 掃描預覽區 -->
        <div id="scanner-section" class="hidden">
            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                <h3 class="text-sm font-semibold text-gray-700 mb-3">掃描預覽</h3>
                <div id="reader"></div>
                <div id="result" class="mt-3 p-3 bg-white rounded-md text-sm">
                    <span class="text-gray-400">等待掃描條碼...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isScanning = false;

        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const scannerSection = document.getElementById('scanner-section');
        const resultDiv = document.getElementById('result');

        // 啟動掃描
        startBtn.addEventListener('click', startScanning);

        // 停止掃描
        stopBtn.addEventListener('click', stopScanning);

        function startScanning() {
            startBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
            scannerSection.classList.remove('hidden');
            isScanning = true;

            // Quagga2 配置
            const config = {
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#reader'),
                    constraints: {
                        width: { min: 640 },
                        height: { min: 480 },
                        facingMode: "environment" // 使用後置鏡頭
                    }
                },
                decoder: {
                    readers: [
                        "code_128_reader",  // Code 128
                        "ean_reader",       // EAN-13
                        "ean_8_reader",     // EAN-8
                        "code_39_reader",   // Code 39
                        "upc_reader",       // UPC-A
                        "upc_e_reader"      // UPC-E
                    ],
                    debug: {
                        drawBoundingBox: true,  // 繪製邊界框
                        drawScanline: true,     // 繪製掃描線
                    }
                },
                locate: true,
                locator: {
                    halfSample: true,
                    patchSize: "medium",
                }
            };

            // 初始化 Quagga
            Quagga.init(config, function(err) {
                if (err) {
                    console.error('初始化失敗:', err);
                    alert('無法啟動攝影機，請確認權限設定');
                    stopScanning();
                    return;
                }
                console.log("Quagga 初始化成功");

                // 註冊偵測事件
                Quagga.onDetected(onBarcodeDetected);

                // 開始掃描
                Quagga.start();
            });
        }

        function stopScanning() {
            if (!isScanning) return;

            isScanning = false;

            // 移除事件監聽
            Quagga.offDetected(onBarcodeDetected);

            // 停止 Quagga
            Quagga.stop();

            // 清理視訊流
            const videoElement = document.querySelector('#reader video');
            if (videoElement && videoElement.srcObject) {
                videoElement.srcObject.getTracks().forEach(track => track.stop());
                videoElement.srcObject = null;
            }

            // 清空 DOM
            document.querySelector('#reader').innerHTML = '';

            // 更新 UI
            startBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');
            scannerSection.classList.add('hidden');
            resultDiv.innerHTML = '<span class="text-gray-400">等待掃描條碼...</span>';
        }

        function onBarcodeDetected(data) {
            if (!data || !data.codeResult) return;

            const code = data.codeResult.code;
            const format = data.codeResult.format;

            console.log('偵測到條碼:', code, '格式:', format);

            // 顯示結果
            resultDiv.innerHTML = `
                <div class="text-green-600 font-bold">
                    ✓ 掃描成功！
                </div>
                <div class="mt-2 text-gray-700">
                    <div><strong>條碼：</strong>${code}</div>
                    <div><strong>格式：</strong>${format}</div>
                </div>
            `;
        }
    </script>

</body>
</html>
